# Simulation in ROS

## Gazebo Simulator

[Gazebo](http://gazebosim.org/) is a 3D simulator.
It makes it possible to rapidly test algorithms,
    design robots,
    perform regression testing,
    and train AI system using realistic scenarios.
Gazebo is integrated with ROS (cf. [Gazebo ROS](http://wiki.ros.org/gazebo_ros_pkgs))
and supports various robots out of the box.

Gazebo is heavily used by the DARPA challenges (cf. [Wikipedia](https://en.wikipedia.org/wiki/Gazebo_simulator)).
You can see videos online ([example](https://www.youtube.com/watch?v=v6-heLIg85o))
and even load the maps and robot model that are available.

## Gazebo Installation

Verify that _Gazebo_ is installed.

```consol
$ dpkg -l | grep gazebo
ii  gazebo11                                        11.12.0-1~focal                      amd64        Open Source Robotics Simulator
ii  gazebo11-common                                 11.12.0-1~focal                      all          Open Source Robotics Simulator - Shared files
ii  gazebo11-plugin-base                            11.12.0-1~focal                      amd64        Open Source Robotics Simulator - base plug-ins
ii  libgazebo11:amd64                               11.12.0-1~focal                      amd64        Open Source Robotics Simulator - shared library
ii  libgazebo11-dev:amd64                           11.12.0-1~focal                      amd64        Open Source Robotics Simulator - Development Files
ii  ros-foxy-gazebo-dev                             3.5.3-1focal.20220829.174620         amd64        Provides a cmake config for the default version of Gazebo for the ROS distribution.
ii  ros-foxy-gazebo-msgs                            3.5.3-1focal.20221012.224922         amd64        Message and service data structures for interacting with Gazebo from ROS2.
ii  ros-foxy-gazebo-plugins                         3.5.3-1focal.20221021.150213         amd64        Robot-independent Gazebo plugins for sensors, motors and dynamic reconfigurable components.
ii  ros-foxy-gazebo-ros                             3.5.3-1focal.20221013.010602         amd64        Utilities to interface with Gazebo through ROS.
```

To notice that you can install missing packages with the command line: `sudo apt install <pakage_name>`.


## Try Gazebo with ROS

The better way to use Gazebo with ROS is to launch he simulator with ROS launch files.
Due to unstable Gazebo/ROS2 version and lack in documentation, we use a vertion with _ROS1_ API.

```sh
source /opt/ros/noetic/setup.bash
```

The configuration is stored in a ros package [larm_material](https://bitbucket.org/imt-mobisyst/larm_material/src/2023/) to clone in the `src` directory of a ros1 workspace (`ros1_ws` for instance).
Then, use _catkin_ to generate the packages and source the `setup` file to upgrade the commands environement

```sh
cd ~/ros1_ws
ls src
catkin_make
source devel/setup.bash
```

Finally you can launch a preconfigured simulation:

```sh
roslaunch larm challenge-1.launch
```

With a look to the launch file [here](https://bitbucket.org/imt-mobisyst/larm_material/src/2023/larm/launch/challenge-1.launch) we understand that gazebo/ros permit to undependly uploa a word configuration and spaw elements like a robots.

Our robots is configured like a tbot, with a laser range and a camera.
The interaction with the simulation will operate through ros topic as it would be a real robot with real equipments.

Try to list and explore the differents topics in a new terminal.

```sh
source /opt/noetic/setup.bash
rostopic list
rostopic info ...
...
```

> Question: In which topic are laser scans published ? and camera images ?


## Connect to ROS2 and Visualize

Topics, like the other tools of ROS, has evolved from _ROS1_ to _ROS2_.
The evolution make them incompatible, but it is possble to start a bridge node to transfer information from _ROS1_ to _ROS2_ and vise-versa

The `ROS1_bridge` (a ros2 package) with it `dynamic_bridge` listen to connection to topics and transfers the data.

Then, `Rviz2` will be capable to read and show the data simulated by Gazebo.
[rviz2](https://index.ros.org/p/rviz2/) is a very useful and versatile tool to visualize data that goes through topics.

Start the dynamic bridge, Rviz2 and visualize the laser scan, and the camera.


## Frame and transformations

Test the main ROS2 GUI tools Rviz and Rqt (in new terminals):

Configure rviz2 to visualize the laser scans.
Be carreful, ensure that `Global Option` / `Fixed frame` is correctly configured to `base_link`.

> Question: why is this important? (hint: check your `tf` using `ros2 run tf_tools view_frames.py`)

![rviz2](../files/SLAM/rviz_laserscan.png)

Use `rqt` to see the graph of ROS nodes and the topics they use to communicate (ref of ROS Qt: [RQt](https://docs.ros.org/en/foxy/Concepts/About-RQt.html)).


## Controlling the Simulated Robot

Launch a simple node to control a robot using keyboard:

```sh
ros2 run teleop_twist_keyboard teleop_twist_keyboard
```

> Why you cannot control the robot ?

Use the `tbot_pytool multiplexer` and command the robot from the '/multi/cmd_teleop' topic.

```sh
# First terminal:
ros2 run tbot_pytool multiplexer
# Second terminal:
ros2 run teleop_twist_keyboard teleop_twist_keyboard --ros-args --remap /cmd_vel:=/multi/cmd_teleop
```

> How many terminals are open ?

## tuto_sim

Create a new package (python or cmake as you want) `tuto_sim` in your _ROS2_ workspace and create a launch file that start with the apropriate confgration: the `dynamic_bridge`, `rviz2`, `multiplexer` and the `teleop`.

All the information you need are in the tutorials on [docs.ros.org](https://docs.ros.org/en/foxy/Tutorials/Intermediate/Launch/Launch-Main.html).





<!-- 
## A program to control the simulated robot

TODO
-->
